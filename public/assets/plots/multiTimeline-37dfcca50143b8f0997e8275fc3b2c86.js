define([require],function(){function t(t){this.selector=t.selector||"#area2",this.legend={},this.legend.selector=t.legend.selector,this.margin=t.margin||{top:20,right:20,bottom:20,left:80},this.width=t.width||960,this.height=t.height||400,this.canvasWidth=this.width-this.margin.left-this.margin.right,this.canvasHeight=this.height-this.margin.top-this.margin.bottom,this.dateFormat="%Y-%m-%d",this.title=t.title||"",this.dataset=t.dataset||[],this.colorScaler=d3.scale.category10(),this.xScaler=d3.time.scale().range([0,this.canvasWidth]),this.yScaler=d3.scale.linear().range([this.canvasHeight,0]),this.dateParser=d3.time.format(this.dateFormat).parse,this.bisectDate=d3.bisector(function(t){return t.date}).left,this.liner=d3.svg.line().interpolate("basis").x(function(t){return this.xScaler(t.date)}).y(function(t){return this.yScaler(t.value)})}return t.prototype.loadAndRender=function(t){var e=this;d3.json(t,function(n,i){return n?(console.error("Can not load data from url: "+t),1):(i.forEach(function(t){t.date=e.dateParser(t.date)}),i.sort(function(t,e){return t.date-e.date}),void e.render(i))})},t.prototype.render=function(t){var e=this;this.colorScaler.domain(d3.keys(t[0]).filter(function(t){return"date"!==t})),e.data=t,e.dataset=this.colorScaler.domain().map(function(e){return{name:e,values:t.map(function(t){return{date:t.date,value:+t[e]}})}}),e.xScaler.domain(d3.extent(t,function(t){return t.date})),e.yScaler.domain([d3.min(e.dataset,function(t){return d3.min(t.values,function(t){return t.value})}),d3.max(e.dataset,function(t){return d3.max(t.values,function(t){return t.value})})]),canvas=e.initCanvas().select(".canvas");var n=canvas.selectAll(".timeline").data(e.dataset).enter().append("g").attr("class","timeline");n.append("path").attr({"class":"line",id:function(t){return"line_"+t.name},d:function(t){return e.liner(t.values)}}).style({opacity:.3,stroke:function(t){return e.colorScaler(t.name)}}),e.addAxisX(),e.addAxisY(),e.addTitle(),e.addLegend()},t.prototype.initCanvas=function(){var t=this,e=d3.select(t.selector).append("svg").attr({width:t.width,height:t.height});return e.append("g").attr("class","canvas").attr("transform","translate("+t.margin.left+","+t.margin.top+")"),t.canvas=e,e},t.prototype.addAxisX=function(){var t=this,e=d3.svg.axis().scale(t.xScaler).orient("bottom").ticks(t.dataset.length,3);t.canvas.append("g").attr({"class":"x axis",transform:"translate("+t.margin.left+","+(t.height-t.margin.bottom)+")"}).call(e)},t.prototype.addAxisY=function(){var t=this,e=d3.svg.axis().scale(t.yScaler).orient("left").ticks(5);t.canvas.append("g").attr("class","y axis").attr("transform","translate("+t.margin.left+","+t.margin.top+")").call(e)},t.prototype.addTitle=function(){var t=this;t.canvas.append("g").attr("class","").append("text").text(t.title).attr({"class":"plotTitle",x:function(){return t.width/2},y:function(){return t.margin.top}})},t.prototype.addFocusator=function(){function t(){{var t=e.xScaler.invert(d3.mouse(this)[0]);e.yScaler.invert(d3.mouse(this)[1])}data=e.data,i=e.bisectDate(data,t,1),d0=data[i-1];var r=i<data.length?data[i]:data[data.length-1],o=t-d0.date>r.date-t?r:d0;console.debug(o),formatHTML="",d3.map(o).forEach(function(t,e){formatHTML+="<li>"+t+":"+e+"</li>"}),n.attr("transform","translate("+d3.mouse(this)[0]+","+d3.mouse(this)[1]+")"),d3.select("#focusator-tooltip").style({opacity:.9,left:d3.event.pageX+"px",top:d3.event.pageY+"px"}).html("<ul>"+formatHTML+"</ul>")}var e=this,n=(d3.select("body").append("div").attr("id","focusator-tooltip").attr("class","nav nav-list tooltip").style({position:"absolute"}).html("test"),e.canvas.append("g").attr("class","focus").style("display","none"));n.append("text").attr({x:9,dy:".35em"}),e.canvas.append("rect").attr({"class":"overlay",width:e.width+"px",height:e.height+"px"}).on("mouseover",function(){n.style("display",null)}).on("mouseout",function(){n.style("display","none")}).on("mousemove",t)},t.prototype.addLegend=function(){var t=this;d3.select(t.legend.selector).append("ul").attr("class","nav nav-pills").style({"padding-left":t.margin.left+"px"}).selectAll(".btn-legend").data(t.dataset).enter().append("li").attr({"class":"btn-legend","data-language":function(t){t.name}}).html(function(e){if("date"!=e.name){var n="",i=t.colorScaler(e.name);n=['<a href = "#">','<i class = "icon-stop" style = "color: ',i,' ;">&nbsp;</i>',"&nbsp;",e.name,"</a>"].join("")}else console.debug("MultiTimeline legend skips: "+e.name);return n}).on("mouseover",function(t){var e="#line_"+t.name;d3.select(e).style("opacity",.9)}).on("mouseout",function(t){console.log("OFF:"+t.name);var e="#line_"+t.name;d3.select(e).style("opacity",.3)})},t});