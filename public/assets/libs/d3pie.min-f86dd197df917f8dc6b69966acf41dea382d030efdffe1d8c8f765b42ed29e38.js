/*!
* d3pie
* @author Ben Keen
* @version 0.1.6
* @date June 2014
* @repo http://github.com/benkeen/d3pie
*/
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t(require()):e.d3pie=t(e)}(this,function(){var e="d3pie",t="0.1.6",n=0,i={header:{title:{text:"",color:"#333333",fontSize:18,font:"arial"},subtitle:{text:"",color:"#666666",fontSize:14,font:"arial"},location:"top-center",titleSubtitlePadding:8},footer:{text:"",color:"#666666",fontSize:14,font:"arial",location:"left"},size:{canvasHeight:500,canvasWidth:500,pieInnerRadius:"0%",pieOuterRadius:null},data:{sortOrder:"none",ignoreSmallSegments:{enabled:!1,valueType:"percentage",value:null},smallSegmentGrouping:{enabled:!1,value:1,valueType:"percentage",label:"Other",color:"#cccccc"},content:[]},labels:{outer:{format:"label",hideWhenLessThanPercentage:null,pieDistance:30},inner:{format:"percentage",hideWhenLessThanPercentage:null},mainLabel:{color:"#333333",font:"arial",fontSize:10},percentage:{color:"#dddddd",font:"arial",fontSize:10,decimalPlaces:0},value:{color:"#cccc44",font:"arial",fontSize:10},lines:{enabled:!0,style:"curved",color:"segment"},truncation:{enabled:!1,length:30}},effects:{load:{effect:"default",speed:1e3},pullOutSegmentOnClick:{effect:"bounce",speed:300,size:10},highlightSegmentOnMouseover:!0,highlightLuminosity:-.2},tooltips:{enabled:!1,type:"placeholder",string:"",placeholderParser:null,styles:{fadeInSpeed:250,backgroundColor:"#000000",backgroundOpacity:.5,color:"#efefef",borderRadius:2,font:"arial",fontSize:10,padding:4}},misc:{colors:{background:null,segments:["#2484c1","#65a620","#7b6888","#a05d56","#961a1a","#d8d23a","#e98125","#d0743c","#635222","#6ada6a","#0c6197","#7d9058","#207f33","#44b9b0","#bca44a","#e4a14b","#a3acb2","#8cc3e9","#69a6f9","#5b388f","#546e91","#8bde95","#d2ab58","#273c71","#98bf6e","#4daa4b","#98abc5","#cc1010","#31383b","#006391","#c2643f","#b0a474","#a5a39c","#a9c2bc","#22af8c","#7fcecf","#987ac6","#3d3b87","#b77b1c","#c9c2b6","#807ece","#8db27c","#be66a2","#9ed3c6","#00644b","#005064","#77979f","#77e079","#9c73ab","#1f79a7"],segmentStroke:"#ffffff"},gradient:{enabled:!1,percentage:95,color:"#000000"},canvasPadding:{top:5,right:5,bottom:5,left:5},pieCenterOffset:{x:0,y:0},cssPrefix:null},callbacks:{onload:null,onMouseoverSegment:null,onMouseoutSegment:null,onClickSegment:null}},r={initialCheck:function(e){var t=e.cssPrefix,n=e.element,i=e.options;if(!window.d3||!window.d3.hasOwnProperty("version"))return console.error("d3pie error: d3 is not available"),!1;if(!(n instanceof HTMLElement||n instanceof SVGElement))return console.error("d3pie error: the first d3pie() param must be a valid DOM element (not jQuery) or a ID string."),!1;if(!/[a-zA-Z][a-zA-Z0-9_-]*$/.test(t))return console.error("d3pie error: invalid options.misc.cssPrefix"),!1;if(!o.isArray(i.data.content))return console.error("d3pie error: invalid config structure: missing data.content property."),!1;if(0===i.data.content.length)return console.error("d3pie error: no data supplied."),!1;for(var r=[],a=0;a<i.data.content.length;a++)"number"!=typeof i.data.content[a].value||isNaN(i.data.content[a].value)?console.log("not valid: ",i.data.content[a]):i.data.content[a].value<=0?console.log("not valid - should have positive value: ",i.data.content[a]):r.push(i.data.content[a]);return e.options.data.content=r,!0}},o={addSVGSpace:function(e){var t=e.element,n=e.options.size.canvasWidth,i=e.options.size.canvasHeight,r=e.options.misc.colors.background,o=d3.select(t).append("svg:svg").attr("width",n).attr("height",i);return"transparent"!==r&&o.style("background-color",function(){return r}),o},whenIdExists:function(e,t){var n=1,i=1e3,r=setInterval(function(){document.getElementById(e)&&(clearInterval(r),t()),n>i&&clearInterval(r),n++},1)},whenElementsExist:function(e,t){var n=1,i=1e3,r=setInterval(function(){for(var o=!0,a=0;a<e.length;a++)if(!document.getElementById(e[a])){o=!1;break}o&&(clearInterval(r),t()),n>i&&clearInterval(r),n++},1)},shuffleArray:function(e){for(var t,n,i=e.length;0!==i;)n=Math.floor(Math.random()*i),i-=1,t=e[i],e[i]=e[n],e[n]=t;return e},processObj:function(e,t,n){return"string"==typeof t?o.processObj(e,t.split("."),n):1===t.length&&void 0!==n?(e[t[0]]=n,e[t[0]]):0===t.length?e:o.processObj(e[t[0]],t.slice(1),n)},getDimensions:function(e){var t=document.getElementById(e),n=0,i=0;if(t){var r=t.getBBox();n=r.width,i=r.height}else console.log("error: getDimensions() "+e+" not found.");return{w:n,h:i}},rectIntersect:function(e,t){var n=t.x>e.x+e.w||t.x+t.w<e.x||t.y+t.h<e.y||t.y>e.y+e.h;return!n},getColorShade:function(e,t){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;for(var n="#",i=0;3>i;i++){var r=parseInt(e.substr(2*i,2),16);r=Math.round(Math.min(Math.max(0,r+r*t),255)).toString(16),n+=("00"+r).substr(r.length)}return n},initSegmentColors:function(e){for(var t=e.options.data.content,n=e.options.misc.colors.segments,i=[],r=0;r<t.length;r++)i.push(t[r].hasOwnProperty("color")?t[r].color:n[r]);return i},applySmallSegmentGrouping:function(e,t){var n;"percentage"===t.valueType&&(n=s.getTotalPieSize(e));for(var i=[],r=[],o=0,a=0;a<e.length;a++)if("percentage"===t.valueType){var u=e[a].value/n*100;if(u<=t.value){r.push(e[a]),o+=e[a].value;continue}e[a].isGrouped=!1,i.push(e[a])}else{if(e[a].value<=t.value){r.push(e[a]),o+=e[a].value;continue}e[a].isGrouped=!1,i.push(e[a])}return r.length&&i.push({color:t.color,label:t.label,value:o,isGrouped:!0,groupedData:r}),i},showPoint:function(e,t,n){e.append("circle").attr("cx",t).attr("cy",n).attr("r",2).style("fill","black")},isFunction:function(e){var t={};return e&&"[object Function]"===t.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)}},a=function(){var e,t,n,i,r,o,s=arguments[0]||{},u=1,l=arguments.length,c=!1,h=Object.prototype.toString,p=Object.prototype.hasOwnProperty,d={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},f={isFunction:function(e){return"function"===f.type(e)},isArray:Array.isArray||function(e){return"array"===f.type(e)},isWindow:function(e){return null!==e&&e===e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null===e?String(e):d[h.call(e)]||"object"},isPlainObject:function(e){if(!e||"object"!==f.type(e)||e.nodeType)return!1;try{if(e.constructor&&!p.call(e,"constructor")&&!p.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n;for(n in e);return void 0===n||p.call(e,n)}};for("boolean"==typeof s&&(c=s,s=arguments[1]||{},u=2),"object"==typeof s||f.isFunction(s)||(s={}),l===u&&(s=this,--u),u;l>u;u++)if(null!==(e=arguments[u]))for(t in e)n=s[t],i=e[t],s!==i&&(c&&i&&(f.isPlainObject(i)||(r=f.isArray(i)))?(r?(r=!1,o=n&&f.isArray(n)?n:[]):o=n&&f.isPlainObject(n)?n:{},s[t]=a(c,o,i)):void 0!==i&&(s[t]=i));return s},s={toRadians:function(e){return e*(Math.PI/180)},toDegrees:function(e){return e*(180/Math.PI)},computePieRadius:function(e){var t=e.options.size,n=e.options.misc.canvasPadding,i=t.canvasWidth-n.left-n.right,r=t.canvasHeight-n.top-n.bottom;"pie-center"!==e.options.header.location&&(r-=e.textComponents.headerHeight),e.textComponents.footer.exists&&(r-=e.textComponents.footer.h),r=0>r?0:r;var o,a,s=(r>i?i:r)/3;if(null!==t.pieOuterRadius)if(/%/.test(t.pieOuterRadius)){a=parseInt(t.pieOuterRadius.replace(/[\D]/,""),10),a=a>99?99:a,a=0>a?0:a;var u=r>i?i:r;if("none"!==e.options.labels.outer.format){var l=2*parseInt(e.options.labels.outer.pieDistance,10);u-l>0&&(u-=l)}s=Math.floor(u/100*a)/2}else s=parseInt(t.pieOuterRadius,10);/%/.test(t.pieInnerRadius)?(a=parseInt(t.pieInnerRadius.replace(/[\D]/,""),10),a=a>99?99:a,a=0>a?0:a,o=Math.floor(s/100*a)):o=parseInt(t.pieInnerRadius,10),e.innerRadius=o,e.outerRadius=s},getTotalPieSize:function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n].value;return t},sortPieData:function(e){var t=e.options.data.content,n=e.options.data.sortOrder;switch(n){case"none":break;case"random":t=o.shuffleArray(t);break;case"value-asc":t.sort(function(e,t){return e.value<t.value?-1:1});break;case"value-desc":t.sort(function(e,t){return e.value<t.value?1:-1});break;case"label-asc":t.sort(function(e,t){return e.label.toLowerCase()>t.label.toLowerCase()?1:-1});break;case"label-desc":t.sort(function(e,t){return e.label.toLowerCase()<t.label.toLowerCase()?1:-1})}return t},getPieTranslateCenter:function(e){return"translate("+e.x+","+e.y+")"},calculatePieCenter:function(e){var t=e.options.misc.pieCenterOffset,n=e.textComponents.title.exists&&"pie-center"!==e.options.header.location,i=e.textComponents.subtitle.exists&&"pie-center"!==e.options.header.location,r=e.options.misc.canvasPadding.top;n&&i?r+=e.textComponents.title.h+e.options.header.titleSubtitlePadding+e.textComponents.subtitle.h:n?r+=e.textComponents.title.h:i&&(r+=e.textComponents.subtitle.h);var o=0;e.textComponents.footer.exists&&(o=e.textComponents.footer.h+e.options.misc.canvasPadding.bottom);var a=(e.options.size.canvasWidth-e.options.misc.canvasPadding.left-e.options.misc.canvasPadding.right)/2+e.options.misc.canvasPadding.left,s=(e.options.size.canvasHeight-o-r)/2+r;a+=t.x,s+=t.y,e.pieCenter={x:a,y:s}},rotate:function(e,t,n,i,r){r=r*Math.PI/180;var o=Math.cos,a=Math.sin,s=(e-n)*o(r)-(t-i)*a(r)+n,u=(e-n)*a(r)+(t-i)*o(r)+i;return{x:s,y:u}},translate:function(e,t,n,i){var r=s.toRadians(i);return{x:e+n*Math.sin(r),y:t-n*Math.cos(r)}},pointIsInArc:function(e,t,n){var i=n.innerRadius()(t),r=n.outerRadius()(t),o=n.startAngle()(t),a=n.endAngle()(t),s=e.x*e.x+e.y*e.y,u=Math.atan2(e.x,-e.y);return u=0>u?u+2*Math.PI:u,s>=i*i&&r*r>=s&&u>=o&&a>=u}},u={add:function(e,t,n){var i=u.getIncludes(n),r=e.options.labels,o=e.svg.insert("g","."+e.cssPrefix+"labels-"+t).attr("class",e.cssPrefix+"labels-"+t),a=o.selectAll("."+e.cssPrefix+"labelGroup-"+t).data(e.options.data.content).enter().append("g").attr("id",function(n,i){return e.cssPrefix+"labelGroup"+i+"-"+t}).attr("data-index",function(e,t){return t}).attr("class",e.cssPrefix+"labelGroup-"+t).style("opacity",0);i.mainLabel&&a.append("text").attr("id",function(n,i){return e.cssPrefix+"segmentMainLabel"+i+"-"+t}).attr("class",e.cssPrefix+"segmentMainLabel-"+t).text(function(e){var t=e.label;return r.truncation.enabled&&e.label.length>r.truncation.length&&(t=e.label.substring(0,r.truncation.length)+"..."),t}).style("font-size",r.mainLabel.fontSize+"px").style("font-family",r.mainLabel.font).style("fill",r.mainLabel.color),i.percentage&&a.append("text").attr("id",function(n,i){return e.cssPrefix+"segmentPercentage"+i+"-"+t}).attr("class",e.cssPrefix+"segmentPercentage-"+t).text(function(t,n){return l.getPercentage(e,n,e.options.labels.percentage.decimalPlaces)+"%"}).style("font-size",r.percentage.fontSize+"px").style("font-family",r.percentage.font).style("fill",r.percentage.color),i.value&&a.append("text").attr("id",function(n,i){return e.cssPrefix+"segmentValue"+i+"-"+t}).attr("class",e.cssPrefix+"segmentValue-"+t).text(function(e){return e.value}).style("font-size",r.value.fontSize+"px").style("font-family",r.value.font).style("fill",r.value.color)},positionLabelElements:function(e,t,n){u["dimensions-"+t]=[];var i=d3.selectAll("."+e.cssPrefix+"labelGroup-"+t);i.each(function(){var n=d3.select(this).selectAll("."+e.cssPrefix+"segmentMainLabel-"+t),i=d3.select(this).selectAll("."+e.cssPrefix+"segmentPercentage-"+t),r=d3.select(this).selectAll("."+e.cssPrefix+"segmentValue-"+t);u["dimensions-"+t].push({mainLabel:null!==n.node()?n.node().getBBox():null,percentage:null!==i.node()?i.node().getBBox():null,value:null!==r.node()?r.node().getBBox():null})});var r=5,o=u["dimensions-"+t];switch(n){case"label-value1":d3.selectAll("."+e.cssPrefix+"segmentValue-"+t).attr("dx",function(e,t){return o[t].mainLabel.width+r});break;case"label-value2":d3.selectAll("."+e.cssPrefix+"segmentValue-"+t).attr("dy",function(e,t){return o[t].mainLabel.height});break;case"label-percentage1":d3.selectAll("."+e.cssPrefix+"segmentPercentage-"+t).attr("dx",function(e,t){return o[t].mainLabel.width+r});break;case"label-percentage2":d3.selectAll("."+e.cssPrefix+"segmentPercentage-"+t).attr("dx",function(e,t){return o[t].mainLabel.width/2-o[t].percentage.width/2}).attr("dy",function(e,t){return o[t].mainLabel.height})}},computeLabelLinePositions:function(e){e.lineCoordGroups=[],d3.selectAll("."+e.cssPrefix+"labelGroup-outer").each(function(t,n){return u.computeLinePosition(e,n)})},computeLinePosition:function(e,t){var n,i,r,o,a=l.getSegmentAngle(t,e.options.data.content,e.totalSize,{midpoint:!0}),u=s.rotate(e.pieCenter.x,e.pieCenter.y-e.outerRadius,e.pieCenter.x,e.pieCenter.y,a),c=e.outerLabelGroupData[t].h/5,h=6,p=Math.floor(a/90),d=4;switch(2===p&&180===a&&(p=1),p){case 0:n=e.outerLabelGroupData[t].x-h-(e.outerLabelGroupData[t].x-h-u.x)/2,i=e.outerLabelGroupData[t].y+(u.y-e.outerLabelGroupData[t].y)/d,r=e.outerLabelGroupData[t].x-h,o=e.outerLabelGroupData[t].y-c;break;case 1:n=u.x+(e.outerLabelGroupData[t].x-u.x)/d,i=u.y+(e.outerLabelGroupData[t].y-u.y)/d,r=e.outerLabelGroupData[t].x-h,o=e.outerLabelGroupData[t].y-c;break;case 2:var f=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+h;n=u.x-(u.x-f)/d,i=u.y+(e.outerLabelGroupData[t].y-u.y)/d,r=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+h,o=e.outerLabelGroupData[t].y-c;break;case 3:var m=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+h;n=m+(u.x-m)/d,i=e.outerLabelGroupData[t].y+(u.y-e.outerLabelGroupData[t].y)/d,r=e.outerLabelGroupData[t].x+e.outerLabelGroupData[t].w+h,o=e.outerLabelGroupData[t].y-c}e.lineCoordGroups[t]="straight"===e.options.labels.lines.style?[{x:u.x,y:u.y},{x:r,y:o}]:[{x:u.x,y:u.y},{x:n,y:i},{x:r,y:o}]},addLabelLines:function(e){var t=e.svg.insert("g","."+e.cssPrefix+"pieChart").attr("class",e.cssPrefix+"lineGroups").style("opacity",0),n=t.selectAll("."+e.cssPrefix+"lineGroup").data(e.lineCoordGroups).enter().append("g").attr("class",e.cssPrefix+"lineGroup"),i=d3.svg.line().interpolate("basis").x(function(e){return e.x}).y(function(e){return e.y});n.append("path").attr("d",i).attr("stroke",function(t,n){return"segment"===e.options.labels.lines.color?e.options.colors[n]:e.options.labels.lines.color}).attr("stroke-width",1).attr("fill","none").style("opacity",function(t,n){var i=e.options.labels.outer.hideWhenLessThanPercentage,r=l.getPercentage(e,n,e.options.labels.percentage.decimalPlaces),o=null!==i&&i>r||""===e.options.data.content[n].label;return o?0:1})},positionLabelGroups:function(e,t){d3.selectAll("."+e.cssPrefix+"labelGroup-"+t).style("opacity",0).attr("transform",function(n,i){var r,u;if("outer"===t)r=e.outerLabelGroupData[i].x,u=e.outerLabelGroupData[i].y;else{var c=a(!0,{},e.pieCenter);if(e.innerRadius>0){var h=l.getSegmentAngle(i,e.options.data.content,e.totalSize,{midpoint:!0}),p=s.translate(e.pieCenter.x,e.pieCenter.y,e.innerRadius,h);c.x=p.x,c.y=p.y}var d=o.getDimensions(e.cssPrefix+"labelGroup"+i+"-inner"),f=d.w/2,m=d.h/4;r=c.x+(e.lineCoordGroups[i][0].x-c.x)/1.8,u=c.y+(e.lineCoordGroups[i][0].y-c.y)/1.8,r-=f,u+=m}return"translate("+r+","+u+")"})},fadeInLabelsAndLines:function(e){var t="default"===e.options.effects.load.effect?e.options.effects.load.speed:1;setTimeout(function(){var t="default"===e.options.effects.load.effect?400:1;d3.selectAll("."+e.cssPrefix+"labelGroup-outer").transition().duration(t).style("opacity",function(t,n){var i=e.options.labels.outer.hideWhenLessThanPercentage,r=l.getPercentage(e,n,e.options.labels.percentage.decimalPlaces);return null!==i&&i>r?0:1}),d3.selectAll("."+e.cssPrefix+"labelGroup-inner").transition().duration(t).style("opacity",function(t,n){var i=e.options.labels.inner.hideWhenLessThanPercentage,r=l.getPercentage(e,n,e.options.labels.percentage.decimalPlaces);return null!==i&&i>r?0:1}),d3.selectAll("g."+e.cssPrefix+"lineGroups").transition().duration(t).style("opacity",1),o.isFunction(e.options.callbacks.onload)&&setTimeout(function(){try{e.options.callbacks.onload()}catch(t){}},t)},t)},getIncludes:function(e){var t=!1,n=!1,i=!1;switch(e){case"label":t=!0;break;case"value":n=!0;break;case"percentage":i=!0;break;case"label-value1":case"label-value2":t=!0,n=!0;break;case"label-percentage1":case"label-percentage2":t=!0,i=!0}return{mainLabel:t,value:n,percentage:i}},computeOuterLabelCoords:function(e){e.svg.selectAll("."+e.cssPrefix+"labelGroup-outer").each(function(t,n){return u.getIdealOuterLabelPositions(e,n)}),u.resolveOuterLabelCollisions(e)},resolveOuterLabelCollisions:function(e){var t=e.options.data.content.length;u.checkConflict(e,0,"clockwise",t),u.checkConflict(e,t-1,"anticlockwise",t)},checkConflict:function(e,t,n,i){var r,a;if(!(1>=i)){var s=e.outerLabelGroupData[t].hs;if(!("clockwise"===n&&"right"!==s||"anticlockwise"===n&&"left"!==s)){var l="clockwise"===n?t+1:t-1,c=e.outerLabelGroupData[t],h=e.outerLabelGroupData[l],p={labelHeights:e.outerLabelGroupData[0].h,center:e.pieCenter,lineLength:e.outerRadius+e.options.labels.outer.pieDistance,heightChange:e.outerLabelGroupData[0].h+1};if("clockwise"===n){for(r=0;t>=r;r++)if(a=e.outerLabelGroupData[r],o.rectIntersect(a,h)){u.adjustLabelPos(e,l,c,p);break}}else for(r=i-1;r>=t;r--)if(a=e.outerLabelGroupData[r],o.rectIntersect(a,h)){u.adjustLabelPos(e,l,c,p);break}u.checkConflict(e,l,n,i)}}},adjustLabelPos:function(e,t,n,i){var r,o,a,s;s=n.y+i.heightChange,o=i.center.y-s,r=Math.sqrt(Math.abs(i.lineLength)>Math.abs(o)?i.lineLength*i.lineLength-o*o:o*o-i.lineLength*i.lineLength),a="right"===n.hs?i.center.x+r:i.center.x-r-e.outerLabelGroupData[t].w,e.outerLabelGroupData[t].x=a,e.outerLabelGroupData[t].y=s},getIdealOuterLabelPositions:function(e,t){var n=d3.select("#"+e.cssPrefix+"labelGroup"+t+"-outer").node().getBBox(),i=l.getSegmentAngle(t,e.options.data.content,e.totalSize,{midpoint:!0}),r=e.pieCenter.x,o=e.pieCenter.y-(e.outerRadius+e.options.labels.outer.pieDistance),a=s.rotate(r,o,e.pieCenter.x,e.pieCenter.y,i),u="right";i>180?(a.x-=n.width+8,u="left"):a.x+=8,e.outerLabelGroupData[t]={x:a.x,y:a.y,w:n.width,h:n.height,hs:u}}},l={create:function(e){var t=e.pieCenter,n=e.options.colors,i=e.options.effects.load,r=e.options.misc.colors.segmentStroke,o=e.svg.insert("g","#"+e.cssPrefix+"title").attr("transform",function(){return s.getPieTranslateCenter(t)}).attr("class",e.cssPrefix+"pieChart"),a=d3.svg.arc().innerRadius(e.innerRadius).outerRadius(e.outerRadius).startAngle(0).endAngle(function(t){return t.value/e.totalSize*2*Math.PI}),u=o.selectAll("."+e.cssPrefix+"arc").data(e.options.data.content).enter().append("g").attr("class",e.cssPrefix+"arc"),c=i.speed;"none"===i.effect&&(c=0),u.append("path").attr("id",function(t,n){return e.cssPrefix+"segment"+n}).attr("fill",function(t,i){var r=n[i];return e.options.misc.gradient.enabled&&(r="url(#"+e.cssPrefix+"grad"+i+")"),r}).style("stroke",r).style("stroke-width",1).transition().ease("cubic-in-out").duration(c).attr("data-index",function(e,t){return t}).attrTween("d",function(t){var n=d3.interpolate({value:0},t);return function(t){return e.arc(n(t))}}),e.svg.selectAll("g."+e.cssPrefix+"arc").attr("transform",function(t,n){var i=0;return n>0&&(i=l.getSegmentAngle(n-1,e.options.data.content,e.totalSize)),"rotate("+i+")"}),e.arc=a},addGradients:function(e){var t=e.svg.append("defs").selectAll("radialGradient").data(e.options.data.content).enter().append("radialGradient").attr("gradientUnits","userSpaceOnUse").attr("cx",0).attr("cy",0).attr("r","120%").attr("id",function(t,n){return e.cssPrefix+"grad"+n});t.append("stop").attr("offset","0%").style("stop-color",function(t,n){return e.options.colors[n]}),t.append("stop").attr("offset",e.options.misc.gradient.percentage+"%").style("stop-color",e.options.misc.gradient.color)},addSegmentEventHandlers:function(e){var t=d3.selectAll("."+e.cssPrefix+"arc,."+e.cssPrefix+"labelGroup-inner,."+e.cssPrefix+"labelGroup-outer");t.on("click",function(){var t,n=d3.select(this);if(n.attr("class")===e.cssPrefix+"arc")t=n.select("path");else{var i=n.attr("data-index");t=d3.select("#"+e.cssPrefix+"segment"+i)}var r=t.attr("class")===e.cssPrefix+"expanded";l.onSegmentEvent(e,e.options.callbacks.onClickSegment,t,r),"none"!==e.options.effects.pullOutSegmentOnClick.effect&&(r?l.closeSegment(e,t.node()):l.openSegment(e,t.node()))}),t.on("mouseover",function(){var t,n,i=d3.select(this);if(i.attr("class")===e.cssPrefix+"arc"?t=i.select("path"):(n=i.attr("data-index"),t=d3.select("#"+e.cssPrefix+"segment"+n)),e.options.effects.highlightSegmentOnMouseover){n=t.attr("data-index");var r=e.options.colors[n];t.style("fill",o.getColorShade(r,e.options.effects.highlightLuminosity))}e.options.tooltips.enabled&&(n=t.attr("data-index"),h.showTooltip(e,n));var a=t.attr("class")===e.cssPrefix+"expanded";l.onSegmentEvent(e,e.options.callbacks.onMouseoverSegment,t,a)}),t.on("mousemove",function(){h.moveTooltip(e)}),t.on("mouseout",function(){var t,n,i=d3.select(this);if(i.attr("class")===e.cssPrefix+"arc"?t=i.select("path"):(n=i.attr("data-index"),t=d3.select("#"+e.cssPrefix+"segment"+n)),e.options.effects.highlightSegmentOnMouseover){n=t.attr("data-index");var r=e.options.colors[n];e.options.misc.gradient.enabled&&(r="url(#"+e.cssPrefix+"grad"+n+")"),t.style("fill",r)}e.options.tooltips.enabled&&(n=t.attr("data-index"),h.hideTooltip(e,n));var o=t.attr("class")===e.cssPrefix+"expanded";l.onSegmentEvent(e,e.options.callbacks.onMouseoutSegment,t,o)})},onSegmentEvent:function(e,t,n,i){if(o.isFunction(t)){var r=parseInt(n.attr("data-index"),10);t({segment:n.node(),index:r,expanded:i,data:e.options.data.content[r]})}},openSegment:function(e,t){e.isOpeningSegment||(e.isOpeningSegment=!0,d3.selectAll("."+e.cssPrefix+"expanded").length>0&&l.closeSegment(e,d3.select("."+e.cssPrefix+"expanded").node()),d3.select(t).transition().ease(e.options.effects.pullOutSegmentOnClick.effect).duration(e.options.effects.pullOutSegmentOnClick.speed).attr("transform",function(t){var n=e.arc.centroid(t),i=n[0],r=n[1],o=Math.sqrt(i*i+r*r),a=parseInt(e.options.effects.pullOutSegmentOnClick.size,10);return"translate("+i/o*a+","+r/o*a+")"}).each("end",function(){e.currentlyOpenSegment=t,e.isOpeningSegment=!1,d3.select(this).attr("class",e.cssPrefix+"expanded")}))},closeSegment:function(e,t){d3.select(t).transition().duration(400).attr("transform","translate(0,0)").each("end",function(){d3.select(this).attr("class",""),e.currentlyOpenSegment=null})},getCentroid:function(e){var t=e.getBBox();return{x:t.x+t.width/2,y:t.y+t.height/2}},getSegmentAngle:function(e,t,n,i){var r,o=a({compounded:!0,midpoint:!1},i),s=t[e].value;if(o.compounded){r=0;for(var u=0;e>=u;u++)r+=t[u].value}"undefined"==typeof r&&(r=s);var l=r/n*360;if(o.midpoint){var c=s/n*360;l-=c/2}return l},getPercentage:function(e,t,n){var i=e.options.data.content[t].value/e.totalSize;return 0>=n?Math.round(100*i):(100*i).toFixed(n)}},c={offscreenCoord:-1e4,addTitle:function(e){e.svg.selectAll("."+e.cssPrefix+"title").data([e.options.header.title]).enter().append("text").text(function(e){return e.text}).attr({id:e.cssPrefix+"title","class":e.cssPrefix+"title",x:c.offscreenCoord,y:c.offscreenCoord}).attr("text-anchor",function(){var t;return t="top-center"===e.options.header.location||"pie-center"===e.options.header.location?"middle":"left"}).attr("fill",function(e){return e.color}).style("font-size",function(e){return e.fontSize+"px"}).style("font-family",function(e){return e.font})},positionTitle:function(e){var t,n=e.textComponents,i=e.options.header.location,r=e.options.misc.canvasPadding,o=e.options.size.canvasWidth,a=e.options.header.titleSubtitlePadding;t="top-left"===i?r.left:(o-r.right)/2+r.left,t+=e.options.misc.pieCenterOffset.x;var s=r.top+n.title.h;if("pie-center"===i)if(s=e.pieCenter.y,n.subtitle.exists){var u=n.title.h+a+n.subtitle.h;s=s-u/2+n.title.h}else s+=n.title.h/4;e.svg.select("#"+e.cssPrefix+"title").attr("x",t).attr("y",s)},addSubtitle:function(e){var t=e.options.header.location;e.svg.selectAll("."+e.cssPrefix+"subtitle").data([e.options.header.subtitle]).enter().append("text").text(function(e){return e.text}).attr("x",c.offscreenCoord).attr("y",c.offscreenCoord).attr("id",e.cssPrefix+"subtitle").attr("class",e.cssPrefix+"subtitle").attr("text-anchor",function(){var e;return e="top-center"===t||"pie-center"===t?"middle":"left"}).attr("fill",function(e){return e.color}).style("font-size",function(e){return e.fontSize+"px"}).style("font-family",function(e){return e.font})},positionSubtitle:function(e){var t,n=e.options.misc.canvasPadding,i=e.options.size.canvasWidth;t="top-left"===e.options.header.location?n.left:(i-n.right)/2+n.left,t+=e.options.misc.pieCenterOffset.x;var r=c.getHeaderHeight(e);e.svg.select("#"+e.cssPrefix+"subtitle").attr("x",t).attr("y",r)},addFooter:function(e){e.svg.selectAll("."+e.cssPrefix+"footer").data([e.options.footer]).enter().append("text").text(function(e){return e.text}).attr("x",c.offscreenCoord).attr("y",c.offscreenCoord).attr("id",e.cssPrefix+"footer").attr("class",e.cssPrefix+"footer").attr("text-anchor",function(){var t="left";return"bottom-center"===e.options.footer.location?t="middle":"bottom-right"===e.options.footer.location&&(t="left"),t}).attr("fill",function(e){return e.color}).style("font-size",function(e){return e.fontSize+"px"}).style("font-family",function(e){return e.font})},positionFooter:function(e){var t,n=e.options.footer.location,i=e.textComponents.footer.w,r=e.options.size.canvasWidth,o=e.options.size.canvasHeight,a=e.options.misc.canvasPadding;t="bottom-left"===n?a.left:"bottom-right"===n?r-i-a.right:r/2,e.svg.select("#"+e.cssPrefix+"footer").attr("x",t).attr("y",o-a.bottom)},getHeaderHeight:function(e){var t;if(e.textComponents.title.exists){var n=e.textComponents.title.h+e.options.header.titleSubtitlePadding+e.textComponents.subtitle.h;t="pie-center"===e.options.header.location?e.pieCenter.y-n/2+n:n+e.options.misc.canvasPadding.top}else if("pie-center"===e.options.header.location){var i=e.options.misc.canvasPadding.bottom+e.textComponents.footer.h;t=(e.options.size.canvasHeight-i)/2+e.options.misc.canvasPadding.top+e.textComponents.subtitle.h/2}else t=e.options.misc.canvasPadding.top+e.textComponents.subtitle.h;return t}},h={addTooltips:function(e){var t=e.svg.insert("g").attr("class",e.cssPrefix+"tooltips");t.selectAll("."+e.cssPrefix+"tooltip").data(e.options.data.content).enter().append("g").attr("class",e.cssPrefix+"tooltip").attr("id",function(t,n){return e.cssPrefix+"tooltip"+n}).style("opacity",0).append("rect").attr({rx:e.options.tooltips.styles.borderRadius,ry:e.options.tooltips.styles.borderRadius,x:-e.options.tooltips.styles.padding,opacity:e.options.tooltips.styles.backgroundOpacity}).style("fill",e.options.tooltips.styles.backgroundColor),t.selectAll("."+e.cssPrefix+"tooltip").data(e.options.data.content).append("text").attr("fill",function(){return e.options.tooltips.styles.color}).style("font-size",function(){return e.options.tooltips.styles.fontSize}).style("font-family",function(){return e.options.tooltips.styles.font}).text(function(t,n){var i=e.options.tooltips.string;return"caption"===e.options.tooltips.type&&(i=t.caption),h.replacePlaceholders(e,i,n,{label:t.label,value:t.value,percentage:l.getPercentage(e,n,e.options.labels.percentage.decimalPlaces)})}),t.selectAll("."+e.cssPrefix+"tooltip rect").attr({width:function(t,n){var i=o.getDimensions(e.cssPrefix+"tooltip"+n);return i.w+2*e.options.tooltips.styles.padding},height:function(t,n){var i=o.getDimensions(e.cssPrefix+"tooltip"+n);return i.h+2*e.options.tooltips.styles.padding},y:function(t,n){var i=o.getDimensions(e.cssPrefix+"tooltip"+n);return-(i.h/2)+1}})},showTooltip:function(e,t){var n=e.options.tooltips.styles.fadeInSpeed;h.currentTooltip===t&&(n=1),h.currentTooltip=t,d3.select("#"+e.cssPrefix+"tooltip"+t).transition().duration(n).style("opacity",function(){return 1}),h.moveTooltip(e)},moveTooltip:function(e){d3.selectAll("#"+e.cssPrefix+"tooltip"+h.currentTooltip).attr("transform",function(){var t=d3.mouse(this.parentNode),n=t[0]+e.options.tooltips.styles.padding+2,i=t[1]-2*e.options.tooltips.styles.padding-2;return"translate("+n+","+i+")"})},hideTooltip:function(e,t){d3.select("#"+e.cssPrefix+"tooltip"+t).style("opacity",function(){return 0}),d3.select("#"+e.cssPrefix+"tooltip"+h.currentTooltip).attr("transform",function(){var t=e.options.size.canvasWidth+1e3,n=e.options.size.canvasHeight+1e3;return"translate("+t+","+n+")"})},replacePlaceholders:function(e,t,n,i){o.isFunction(e.options.tooltips.placeholderParser)&&e.options.tooltips.placeholderParser(n,i);var r=function(){return function(){var e=arguments[1];return i.hasOwnProperty(e)?i[arguments[1]]:arguments[0]}};return t.replace(/\{(\w+)\}/g,r(i))}},p=function(u,l){if(this.element=u,"string"==typeof u){var c=u.replace(/^#/,"");this.element=document.getElementById(c)}var h={};a(!0,h,i,l),this.options=h,null!==this.options.misc.cssPrefix?this.cssPrefix=this.options.misc.cssPrefix:(this.cssPrefix="p"+n+"_",n++),r.initialCheck(this)&&(d3.select(this.element).attr(e,t),this.options.data.content=s.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=o.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=o.initSegmentColors(this),this.totalSize=s.getTotalPieSize(this.options.data.content),d.call(this))};p.prototype.recreate=function(){this.options.data.content=s.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=o.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=o.initSegmentColors(this),this.totalSize=s.getTotalPieSize(this.options.data.content),d.call(this)},p.prototype.redraw=function(){this.element.innerHTML="",d.call(this)},p.prototype.destroy=function(){this.element.innerHTML="",d3.select(this.element).attr(e,null)},p.prototype.getOpenSegment=function(){var e=this.currentlyOpenSegment;if(null!==e&&"undefined"!=typeof e){var t=parseInt(d3.select(e).attr("data-index"),10);return{element:e,index:t,data:this.options.data.content[t]}}return null},p.prototype.openSegment=function(e){e=parseInt(e,10),0>e||e>this.options.data.content.length-1||l.openSegment(this,d3.select("#"+this.cssPrefix+"segment"+e).node())},p.prototype.closeSegment=function(){var e=this.currentlyOpenSegment;e&&l.closeSegment(this,e)},p.prototype.updateProp=function(e,t){switch(e){case"header.title.text":var n=o.processObj(this.options,e);o.processObj(this.options,e,t),d3.select("#"+this.cssPrefix+"title").html(t),(""===n&&""!==t||""!==n&&""===t)&&this.redraw();break;case"header.subtitle.text":var i=o.processObj(this.options,e);o.processObj(this.options,e,t),d3.select("#"+this.cssPrefix+"subtitle").html(t),(""===i&&""!==t||""!==i&&""===t)&&this.redraw();break;case"callbacks.onload":case"callbacks.onMouseoverSegment":case"callbacks.onMouseoutSegment":case"callbacks.onClickSegment":case"effects.pullOutSegmentOnClick.effect":case"effects.pullOutSegmentOnClick.speed":case"effects.pullOutSegmentOnClick.size":case"effects.highlightSegmentOnMouseover":case"effects.highlightLuminosity":o.processObj(this.options,e,t);break;default:o.processObj(this.options,e,t),this.destroy(),this.recreate()}};var d=function(){this.svg=o.addSVGSpace(this),this.textComponents={headerHeight:0,title:{exists:""!==this.options.header.title.text,h:0,w:0},subtitle:{exists:""!==this.options.header.subtitle.text,h:0,w:0},footer:{exists:""!==this.options.footer.text,h:0,w:0}},this.outerLabelGroupData=[],this.textComponents.title.exists&&c.addTitle(this),this.textComponents.subtitle.exists&&c.addSubtitle(this),c.addFooter(this);var e=this;o.whenIdExists(this.cssPrefix+"footer",function(){c.positionFooter(e);var t=o.getDimensions(e.cssPrefix+"footer");e.textComponents.footer.h=t.h,e.textComponents.footer.w=t.w});var t=[];this.textComponents.title.exists&&t.push(this.cssPrefix+"title"),this.textComponents.subtitle.exists&&t.push(this.cssPrefix+"subtitle"),this.textComponents.footer.exists&&t.push(this.cssPrefix+"footer"),o.whenElementsExist(t,function(){if(e.textComponents.title.exists){var t=o.getDimensions(e.cssPrefix+"title");e.textComponents.title.h=t.h,e.textComponents.title.w=t.w}if(e.textComponents.subtitle.exists){var n=o.getDimensions(e.cssPrefix+"subtitle");e.textComponents.subtitle.h=n.h,e.textComponents.subtitle.w=n.w}if(e.textComponents.title.exists||e.textComponents.subtitle.exists){var i=0;e.textComponents.title.exists&&(i+=e.textComponents.title.h,e.textComponents.subtitle.exists&&(i+=e.options.header.titleSubtitlePadding)),e.textComponents.subtitle.exists&&(i+=e.textComponents.subtitle.h),e.textComponents.headerHeight=i}s.computePieRadius(e),s.calculatePieCenter(e),c.positionTitle(e),c.positionSubtitle(e),e.options.misc.gradient.enabled&&l.addGradients(e),l.create(e),u.add(e,"inner",e.options.labels.inner.format),u.add(e,"outer",e.options.labels.outer.format),u.positionLabelElements(e,"inner",e.options.labels.inner.format),u.positionLabelElements(e,"outer",e.options.labels.outer.format),u.computeOuterLabelCoords(e),u.positionLabelGroups(e,"outer"),u.computeLabelLinePositions(e),e.options.labels.lines.enabled&&"none"!==e.options.labels.outer.format&&u.addLabelLines(e),u.positionLabelGroups(e,"inner"),u.fadeInLabelsAndLines(e),e.options.tooltips.enabled&&h.addTooltips(e),l.addSegmentEventHandlers(e)
})};return p});