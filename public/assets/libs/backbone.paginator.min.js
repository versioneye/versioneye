/*! backbone.paginator - v0.7.0 - 3/25/2013
* http://github.com/addyosmani/backbone.paginator
* Copyright (c) 2013 Addy Osmani; Licensed MIT */
Backbone.Paginator=function(e,t,n){"use strict";var i={};return i.version="0.7.0",i.clientPager=e.Collection.extend({useDiacriticsPlugin:!0,useLevenshteinPlugin:!0,sortColumn:"",sortDirection:"desc",lastSortColumn:"",fieldFilterRules:[],lastFieldFilterRules:[],filterFields:"",filterExpression:"",lastFilterExpression:"",defaults_ui:{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4},initialize:function(){this.on("add",this.addModel,this),this.on("remove",this.removeModel,this),this.setDefaults()},setDefaults:function(){var e=t.defaults(this.paginator_ui,this.defaults_ui);t.defaults(this,e)},addModel:function(e){this.origModels.push(e)},removeModel:function(e){var n=t.indexOf(this.origModels,e);this.origModels.splice(n,1)},sync:function(i,a,r){var o=this;this.setDefaults();var s={};t.each(t.result(o,"server_api"),function(e,n){t.isFunction(e)&&(e=t.bind(e,o),e=e()),s[n]=e});var l=t.clone(o.paginator_core);t.each(l,function(e,n){t.isFunction(e)&&(e=t.bind(e,o),e=e()),l[n]=e}),l=t.defaults(l,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),l=t.extend(l,{data:decodeURIComponent(n.param(s)),processData:!1,url:t.result(l,"url")},r);var c=e.VERSION.split("."),u=!(0===parseInt(c[0],10)&&9===parseInt(c[1],10)&&10===parseInt(c[2],10)),h=l.success;l.success=function(e,t,n){h&&(u?h(e,t,n):h(a,e,l)),a&&a.trigger&&a.trigger("sync",a,e,l)};var f=l.error;l.error=function(e){f&&f(a,e,l),a&&a.trigger&&a.trigger("error",a,e,l)};var d=l.xhr=n.ajax(l);return a&&a.trigger&&a.trigger("request",a,d,l),d},nextPage:function(e){this.currentPage<this.information.totalPages&&(this.currentPage=++this.currentPage,this.pager(e))},previousPage:function(e){this.currentPage>1&&(this.currentPage=--this.currentPage,this.pager(e))},goTo:function(e,t){void 0!==e&&(this.currentPage=parseInt(e,10),this.pager(t))},howManyPer:function(e){if(void 0!==e){var t=this.perPage;this.perPage=parseInt(e,10),this.currentPage=Math.ceil((t*(this.currentPage-1)+1)/e),this.pager()}},setSort:function(e,t){void 0!==e&&void 0!==t&&(this.lastSortColumn=this.sortColumn,this.sortColumn=e,this.sortDirection=t,this.pager(),this.info())},setFieldFilter:function(e){t.isEmpty(e)?(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules="",this.pager(),this.info()):(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules=e,this.pager(),this.info())},doFakeFieldFilter:function(e){if(!t.isEmpty(e)){var n=this.origModels;return void 0===n&&(n=this.models),n=this._fieldFilter(n,e),""!==this.filterExpression&&(n=this._filter(n,this.filterFields,this.filterExpression)),n.length}},setFilter:function(e,t){void 0!==e&&void 0!==t&&(this.filterFields=e,this.lastFilterExpression=this.filterExpression,this.filterExpression=t,this.pager(),this.info())},doFakeFilter:function(e,n){if(void 0!==e&&void 0!==n){var i=this.origModels;return void 0===i&&(i=this.models),t.isEmpty(this.fieldFilterRules)||(i=this._fieldFilter(i,this.fieldFilterRules)),i=this._filter(i,e,n),i.length}},pager:function(e){var n=this,i=this.perPage,a=(n.currentPage-1)*i,r=a+i;void 0===n.origModels&&(n.origModels=n.models),n.models=n.origModels.slice(),""!==this.sortColumn&&(n.models=n._sort(n.models,this.sortColumn,this.sortDirection)),t.isEmpty(this.fieldFilterRules)||(n.models=n._fieldFilter(n.models,this.fieldFilterRules)),""!==this.filterExpression&&(n.models=n._filter(n.models,this.filterFields,this.filterExpression)),this.lastSortColumn===this.sortColumn&&this.lastFilterExpression===this.filterExpression&&t.isEqual(this.fieldFilterRules,this.lastFieldFilterRules)||(a=0,r=a+i,n.currentPage=1,this.lastSortColumn=this.sortColumn,this.lastFieldFilterRules=this.fieldFilterRules,this.lastFilterExpression=this.filterExpression),n.sortedAndFilteredModels=n.models.slice(),n.info(),n.reset(n.models.slice(a,r)),t.result(e,"success")},_sort:function(e,n,i){return e=e.sort(function(e,a){var r=e.get(n),o=a.get(n);if(t.isUndefined(r)||t.isUndefined(o)||null===r||null===o)return 0;if(r=(""+r).toLowerCase(),o=(""+o).toLowerCase(),"desc"===i)if(!r.match(/[^\-\d\.]/)&&r.match(/-?[\d\.]+/)&&!o.match(/[^\-\d\.]/)&&o.match(/-?[\d\.]+/)){if(o-0>r-0)return 1;if(r-0>o-0)return-1}else{if(o>r)return 1;if(r>o)return-1}else if(!r.match(/[^\-\d\.]/)&&r.match(/-?[\d\.]+/)&&!o.match(/[^\-\d\.]/)&&o.match(/-?[\d\.]+/)){if(o-0>r-0)return-1;if(r-0>o-0)return 1}else{if(o>r)return-1;if(r>o)return 1}if(e.cid&&a.cid){var s=e.cid,l=a.cid;if(l>s)return-1;if(s>l)return 1}return 0})},_fieldFilter:function(e,n){if(t.isEmpty(n))return e;var i=[];return t.each(e,function(e){var a=!0;t.each(n,function(n){if(!a)return!1;if(a=!1,"function"===n.type){var i=t.wrap(n.value,function(t){return t(e.get(n.field))});i()&&(a=!0)}else"required"===n.type?t.isEmpty(""+e.get(n.field))||(a=!0):"min"===n.type?!t.isNaN(Number(e.get(n.field)))&&!t.isNaN(Number(n.value))&&Number(e.get(n.field))>=Number(n.value)&&(a=!0):"max"===n.type?!t.isNaN(Number(e.get(n.field)))&&!t.isNaN(Number(n.value))&&Number(e.get(n.field))<=Number(n.value)&&(a=!0):"range"===n.type?!t.isNaN(Number(e.get(n.field)))&&t.isObject(n.value)&&!t.isNaN(Number(n.value.min))&&!t.isNaN(Number(n.value.max))&&Number(e.get(n.field))>=Number(n.value.min)&&Number(e.get(n.field))<=Number(n.value.max)&&(a=!0):"minLength"===n.type?(""+e.get(n.field)).length>=n.value&&(a=!0):"maxLength"===n.type?(""+e.get(n.field)).length<=n.value&&(a=!0):"rangeLength"===n.type?t.isObject(n.value)&&!t.isNaN(Number(n.value.min))&&!t.isNaN(Number(n.value.max))&&(""+e.get(n.field)).length>=n.value.min&&(""+e.get(n.field)).length<=n.value.max&&(a=!0):"oneOf"===n.type?t.isArray(n.value)&&t.include(n.value,e.get(n.field))&&(a=!0):"equalTo"===n.type?n.value===e.get(n.field)&&(a=!0):"containsAllOf"===n.type?t.isArray(n.value)&&t.isArray(e.get(n.field))&&t.intersection(n.value,e.get(n.field)).length===n.value.length&&(a=!0):"pattern"===n.type?(""+e.get(n.field)).match(n.value)&&(a=!0):a=!1}),a&&i.push(e)}),i},_filter:function(n,i,a){var r=this,o={};if(t.isString(i)?o[i]={cmp_method:"regexp"}:t.isArray(i)?t.each(i,function(e){o[e]={cmp_method:"regexp"}}):t.each(i,function(e,n){o[n]=t.defaults(e,{cmp_method:"regexp"})}),i=o,t.has(e.Paginator,"removeDiacritics")&&r.useDiacriticsPlugin&&(a=e.Paginator.removeDiacritics(a)),""===a||!t.isString(a))return n;var s=t.map(a.match(/\w+/gi),function(e){return e.toLowerCase()}),l="("+t.uniq(s).join("|")+")",c=RegExp(l,"igm"),u=[];return t.each(n,function(n){var o=[];t.each(i,function(i,l){var u=n.get(l);if(u){var h=[];if(u=t.has(e.Paginator,"removeDiacritics")&&r.useDiacriticsPlugin?e.Paginator.removeDiacritics(""+u):""+u,"levenshtein"===i.cmp_method&&t.has(e.Paginator,"levenshtein")&&r.useLevenshteinPlugin){var f=e.Paginator.levenshtein(u,a);t.defaults(i,{max_distance:0}),i.max_distance>=f&&(h=t.uniq(s))}else h=u.match(c);h=t.map(h,function(e){return(""+e).toLowerCase()}),t.each(h,function(e){o.push(e)})}}),o=t.uniq(t.without(o,"")),t.isEmpty(t.difference(s,o))&&u.push(n)}),u},info:function(){var e=this,t={},n=e.sortedAndFilteredModels?e.sortedAndFilteredModels.length:e.length,i=Math.ceil(n/e.perPage);return t={totalUnfilteredRecords:e.origModels.length,totalRecords:n,currentPage:e.currentPage,perPage:this.perPage,totalPages:i,lastPage:i,previous:!1,next:!1,startRecord:0===n?0:(e.currentPage-1)*this.perPage+1,endRecord:Math.min(n,e.currentPage*this.perPage)},e.currentPage>1&&(t.previous=e.currentPage-1),e.currentPage<t.totalPages&&(t.next=e.currentPage+1),t.pageSet=e.setPagination(t),e.information=t,t},setPagination:function(e){var t=[],n=0,i=0,a=2*this.pagesInRange,r=Math.ceil(e.totalRecords/e.perPage);if(r>1)if(1+a>=r)for(n=1,i=r;i>=n;n++)t.push(n);else if(e.currentPage<=this.pagesInRange+1)for(n=1,i=2+a;i>n;n++)t.push(n);else if(r-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange)for(n=e.currentPage-this.pagesInRange;e.currentPage+this.pagesInRange>=n;n++)t.push(n);else for(n=r-a;r>=n;n++)t.push(n);return t},bootstrap:function(e){return t.extend(this,e),this.goTo(1),this.info(),this}}),i.clientPager.prototype.prevPage=i.clientPager.prototype.previousPage,i.requestPager=e.Collection.extend({sync:function(i,a,r){var o=this;o.setDefaults();var s={};t.each(t.result(o,"server_api"),function(e,n){t.isFunction(e)&&(e=t.bind(e,o),e=e()),s[n]=e});var l=t.clone(o.paginator_core);t.each(l,function(e,n){t.isFunction(e)&&(e=t.bind(e,o),e=e()),l[n]=e}),l=t.defaults(l,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),r.data=decodeURIComponent(r.data?n.param(t.extend(s,r.data)):n.param(s)),l=t.extend(l,{data:decodeURIComponent(n.param(s)),processData:!1,url:t.result(l,"url")},r);var c=e.VERSION.split("."),u=!(0===parseInt(c[0],10)&&9===parseInt(c[1],10)&&10===parseInt(c[2],10)),h=l.success;l.success=function(e,t,n){h&&(u?h(e,t,n):h(a,e,l)),a&&a.trigger&&a.trigger("sync",a,e,l)};var f=l.error;l.error=function(e){f&&f(a,e,l),a&&a.trigger&&a.trigger("error",a,e,l)};var d=l.xhr=n.ajax(l);return a&&a.trigger&&a.trigger("request",a,d,l),d},setDefaults:function(){var e=this;t.defaults(e.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4}),t.each(e.paginator_ui,function(n,i){t.isUndefined(e[i])&&(e[i]=e.paginator_ui[i])})},requestNextPage:function(e){if(void 0!==this.currentPage)return this.currentPage+=1,this.pager(e);var t=new n.Deferred;return t.reject(),t.promise()},requestPreviousPage:function(e){if(void 0!==this.currentPage)return this.currentPage-=1,this.pager(e);var t=new n.Deferred;return t.reject(),t.promise()},updateOrder:function(e){void 0!==e&&(this.sortField=e,this.pager())},goTo:function(e,t){if(void 0!==e)return this.currentPage=parseInt(e,10),this.pager(t);var i=new n.Deferred;return i.reject(),i.promise()},howManyPer:function(e){void 0!==e&&(this.currentPage=this.firstPage,this.perPage=e,this.pager())},info:function(){var e={totalRecords:this.totalRecords||0,currentPage:this.currentPage,firstPage:this.firstPage,totalPages:Math.ceil(this.totalRecords/this.perPage),lastPage:this.totalPages,perPage:this.perPage,previous:!1,next:!1};return this.currentPage>1&&(e.previous=this.currentPage-1),this.currentPage<e.totalPages&&(e.next=this.currentPage+1),e.hasNext=e.next,e.hasPrevious=e.next,e.pageSet=this.setPagination(e),this.information=e,e},setPagination:function(e){var t=[],n=0,i=0,a=2*this.pagesInRange,r=Math.ceil(e.totalRecords/e.perPage);if(r>1)if(1+a>=r)for(n=1,i=r;i>=n;n++)t.push(n);else if(e.currentPage<=this.pagesInRange+1)for(n=1,i=2+a;i>n;n++)t.push(n);else if(r-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange)for(n=e.currentPage-this.pagesInRange;e.currentPage+this.pagesInRange>=n;n++)t.push(n);else for(n=r-a;r>=n;n++)t.push(n);return t},pager:function(e){return t.isObject(e)||(e={}),this.fetch(e)},url:function(){return void 0!==this.paginator_core&&void 0!==this.paginator_core.url?this.paginator_core.url:null},bootstrap:function(e){return t.extend(this,e),this.setDefaults(),this.info(),this}}),i.requestPager.prototype.nextPage=i.requestPager.prototype.requestNextPage,i.requestPager.prototype.prevPage=i.requestPager.prototype.requestPreviousPage,i}(Backbone,_,jQuery);