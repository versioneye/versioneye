/*! backbone.paginator - v0.7.0 - 3/25/2013
* http://github.com/addyosmani/backbone.paginator
* Copyright (c) 2013 Addy Osmani; Licensed MIT */
Backbone.Paginator=function(e,t,i){"use strict";var n={};return n.version="0.7.0",n.clientPager=e.Collection.extend({useDiacriticsPlugin:!0,useLevenshteinPlugin:!0,sortColumn:"",sortDirection:"desc",lastSortColumn:"",fieldFilterRules:[],lastFieldFilterRules:[],filterFields:"",filterExpression:"",lastFilterExpression:"",defaults_ui:{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4},initialize:function(){this.on("add",this.addModel,this),this.on("remove",this.removeModel,this),this.setDefaults()},setDefaults:function(){var e=t.defaults(this.paginator_ui,this.defaults_ui);t.defaults(this,e)},addModel:function(e){this.origModels.push(e)},removeModel:function(e){var i=t.indexOf(this.origModels,e);this.origModels.splice(i,1)},sync:function(n,a,r){var s=this;this.setDefaults();var o={};t.each(t.result(s,"server_api"),function(e,i){t.isFunction(e)&&(e=t.bind(e,s),e=e()),o[i]=e});var l=t.clone(s.paginator_core);t.each(l,function(e,i){t.isFunction(e)&&(e=t.bind(e,s),e=e()),l[i]=e}),l=t.defaults(l,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),l=t.extend(l,{data:decodeURIComponent(i.param(o)),processData:!1,url:t.result(l,"url")},r);var c=e.VERSION.split("."),h=!(0===parseInt(c[0],10)&&9===parseInt(c[1],10)&&10===parseInt(c[2],10)),u=l.success;l.success=function(e,t,i){u&&(h?u(e,t,i):u(a,e,l)),a&&a.trigger&&a.trigger("sync",a,e,l)};var f=l.error;l.error=function(e){f&&f(a,e,l),a&&a.trigger&&a.trigger("error",a,e,l)};var d=l.xhr=i.ajax(l);return a&&a.trigger&&a.trigger("request",a,d,l),d},nextPage:function(e){this.currentPage<this.information.totalPages&&(this.currentPage=++this.currentPage,this.pager(e))},previousPage:function(e){this.currentPage>1&&(this.currentPage=--this.currentPage,this.pager(e))},goTo:function(e,t){void 0!==e&&(this.currentPage=parseInt(e,10),this.pager(t))},howManyPer:function(e){if(void 0!==e){var t=this.perPage;this.perPage=parseInt(e,10),this.currentPage=Math.ceil((t*(this.currentPage-1)+1)/e),this.pager()}},setSort:function(e,t){void 0!==e&&void 0!==t&&(this.lastSortColumn=this.sortColumn,this.sortColumn=e,this.sortDirection=t,this.pager(),this.info())},setFieldFilter:function(e){t.isEmpty(e)?(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules="",this.pager(),this.info()):(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules=e,this.pager(),this.info())},doFakeFieldFilter:function(e){if(!t.isEmpty(e)){var i=this.origModels;return void 0===i&&(i=this.models),i=this._fieldFilter(i,e),""!==this.filterExpression&&(i=this._filter(i,this.filterFields,this.filterExpression)),i.length}},setFilter:function(e,t){void 0!==e&&void 0!==t&&(this.filterFields=e,this.lastFilterExpression=this.filterExpression,this.filterExpression=t,this.pager(),this.info())},doFakeFilter:function(e,i){if(void 0!==e&&void 0!==i){var n=this.origModels;return void 0===n&&(n=this.models),t.isEmpty(this.fieldFilterRules)||(n=this._fieldFilter(n,this.fieldFilterRules)),n=this._filter(n,e,i),n.length}},pager:function(e){var i=this,n=this.perPage,a=(i.currentPage-1)*n,r=a+n;void 0===i.origModels&&(i.origModels=i.models),i.models=i.origModels.slice(),""!==this.sortColumn&&(i.models=i._sort(i.models,this.sortColumn,this.sortDirection)),t.isEmpty(this.fieldFilterRules)||(i.models=i._fieldFilter(i.models,this.fieldFilterRules)),""!==this.filterExpression&&(i.models=i._filter(i.models,this.filterFields,this.filterExpression)),this.lastSortColumn===this.sortColumn&&this.lastFilterExpression===this.filterExpression&&t.isEqual(this.fieldFilterRules,this.lastFieldFilterRules)||(a=0,r=a+n,i.currentPage=1,this.lastSortColumn=this.sortColumn,this.lastFieldFilterRules=this.fieldFilterRules,this.lastFilterExpression=this.filterExpression),i.sortedAndFilteredModels=i.models.slice(),i.info(),i.reset(i.models.slice(a,r)),t.result(e,"success")},_sort:function(e,i,n){return e=e.sort(function(e,a){var r=e.get(i),s=a.get(i);if(t.isUndefined(r)||t.isUndefined(s)||null===r||null===s)return 0;if(r=(""+r).toLowerCase(),s=(""+s).toLowerCase(),"desc"===n)if(!r.match(/[^\-\d\.]/)&&r.match(/-?[\d\.]+/)&&!s.match(/[^\-\d\.]/)&&s.match(/-?[\d\.]+/)){if(s-0>r-0)return 1;if(r-0>s-0)return-1}else{if(s>r)return 1;if(r>s)return-1}else if(!r.match(/[^\-\d\.]/)&&r.match(/-?[\d\.]+/)&&!s.match(/[^\-\d\.]/)&&s.match(/-?[\d\.]+/)){if(s-0>r-0)return-1;if(r-0>s-0)return 1}else{if(s>r)return-1;if(r>s)return 1}if(e.cid&&a.cid){var o=e.cid,l=a.cid;if(l>o)return-1;if(o>l)return 1}return 0})},_fieldFilter:function(e,i){if(t.isEmpty(i))return e;var n=[];return t.each(e,function(e){var a=!0;t.each(i,function(i){if(!a)return!1;if(a=!1,"function"===i.type){var n=t.wrap(i.value,function(t){return t(e.get(i.field))});n()&&(a=!0)}else"required"===i.type?t.isEmpty(""+e.get(i.field))||(a=!0):"min"===i.type?!t.isNaN(Number(e.get(i.field)))&&!t.isNaN(Number(i.value))&&Number(e.get(i.field))>=Number(i.value)&&(a=!0):"max"===i.type?!t.isNaN(Number(e.get(i.field)))&&!t.isNaN(Number(i.value))&&Number(e.get(i.field))<=Number(i.value)&&(a=!0):"range"===i.type?!t.isNaN(Number(e.get(i.field)))&&t.isObject(i.value)&&!t.isNaN(Number(i.value.min))&&!t.isNaN(Number(i.value.max))&&Number(e.get(i.field))>=Number(i.value.min)&&Number(e.get(i.field))<=Number(i.value.max)&&(a=!0):"minLength"===i.type?(""+e.get(i.field)).length>=i.value&&(a=!0):"maxLength"===i.type?(""+e.get(i.field)).length<=i.value&&(a=!0):"rangeLength"===i.type?t.isObject(i.value)&&!t.isNaN(Number(i.value.min))&&!t.isNaN(Number(i.value.max))&&(""+e.get(i.field)).length>=i.value.min&&(""+e.get(i.field)).length<=i.value.max&&(a=!0):"oneOf"===i.type?t.isArray(i.value)&&t.include(i.value,e.get(i.field))&&(a=!0):"equalTo"===i.type?i.value===e.get(i.field)&&(a=!0):"containsAllOf"===i.type?t.isArray(i.value)&&t.isArray(e.get(i.field))&&t.intersection(i.value,e.get(i.field)).length===i.value.length&&(a=!0):"pattern"===i.type?(""+e.get(i.field)).match(i.value)&&(a=!0):a=!1}),a&&n.push(e)}),n},_filter:function(i,n,a){var r=this,s={};if(t.isString(n)?s[n]={cmp_method:"regexp"}:t.isArray(n)?t.each(n,function(e){s[e]={cmp_method:"regexp"}}):t.each(n,function(e,i){s[i]=t.defaults(e,{cmp_method:"regexp"})}),n=s,t.has(e.Paginator,"removeDiacritics")&&r.useDiacriticsPlugin&&(a=e.Paginator.removeDiacritics(a)),""===a||!t.isString(a))return i;var o=t.map(a.match(/\w+/gi),function(e){return e.toLowerCase()}),l="("+t.uniq(o).join("|")+")",c=RegExp(l,"igm"),h=[];return t.each(i,function(i){var s=[];t.each(n,function(n,l){var h=i.get(l);if(h){var u=[];if(h=t.has(e.Paginator,"removeDiacritics")&&r.useDiacriticsPlugin?e.Paginator.removeDiacritics(""+h):""+h,"levenshtein"===n.cmp_method&&t.has(e.Paginator,"levenshtein")&&r.useLevenshteinPlugin){var f=e.Paginator.levenshtein(h,a);t.defaults(n,{max_distance:0}),n.max_distance>=f&&(u=t.uniq(o))}else u=h.match(c);u=t.map(u,function(e){return(""+e).toLowerCase()}),t.each(u,function(e){s.push(e)})}}),s=t.uniq(t.without(s,"")),t.isEmpty(t.difference(o,s))&&h.push(i)}),h},info:function(){var e=this,t={},i=e.sortedAndFilteredModels?e.sortedAndFilteredModels.length:e.length,n=Math.ceil(i/e.perPage);return t={totalUnfilteredRecords:e.origModels.length,totalRecords:i,currentPage:e.currentPage,perPage:this.perPage,totalPages:n,lastPage:n,previous:!1,next:!1,startRecord:0===i?0:(e.currentPage-1)*this.perPage+1,endRecord:Math.min(i,e.currentPage*this.perPage)},e.currentPage>1&&(t.previous=e.currentPage-1),e.currentPage<t.totalPages&&(t.next=e.currentPage+1),t.pageSet=e.setPagination(t),e.information=t,t},setPagination:function(e){var t=[],i=0,n=0,a=2*this.pagesInRange,r=Math.ceil(e.totalRecords/e.perPage);if(r>1)if(1+a>=r)for(i=1,n=r;n>=i;i++)t.push(i);else if(e.currentPage<=this.pagesInRange+1)for(i=1,n=2+a;n>i;i++)t.push(i);else if(r-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange)for(i=e.currentPage-this.pagesInRange;e.currentPage+this.pagesInRange>=i;i++)t.push(i);else for(i=r-a;r>=i;i++)t.push(i);return t},bootstrap:function(e){return t.extend(this,e),this.goTo(1),this.info(),this}}),n.clientPager.prototype.prevPage=n.clientPager.prototype.previousPage,n.requestPager=e.Collection.extend({sync:function(n,a,r){var s=this;s.setDefaults();var o={};t.each(t.result(s,"server_api"),function(e,i){t.isFunction(e)&&(e=t.bind(e,s),e=e()),o[i]=e});var l=t.clone(s.paginator_core);t.each(l,function(e,i){t.isFunction(e)&&(e=t.bind(e,s),e=e()),l[i]=e}),l=t.defaults(l,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),r.data=decodeURIComponent(r.data?i.param(t.extend(o,r.data)):i.param(o)),l=t.extend(l,{data:decodeURIComponent(i.param(o)),processData:!1,url:t.result(l,"url")},r);var c=e.VERSION.split("."),h=!(0===parseInt(c[0],10)&&9===parseInt(c[1],10)&&10===parseInt(c[2],10)),u=l.success;l.success=function(e,t,i){u&&(h?u(e,t,i):u(a,e,l)),a&&a.trigger&&a.trigger("sync",a,e,l)};var f=l.error;l.error=function(e){f&&f(a,e,l),a&&a.trigger&&a.trigger("error",a,e,l)};var d=l.xhr=i.ajax(l);return a&&a.trigger&&a.trigger("request",a,d,l),d},setDefaults:function(){var e=this;t.defaults(e.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4}),t.each(e.paginator_ui,function(i,n){t.isUndefined(e[n])&&(e[n]=e.paginator_ui[n])})},requestNextPage:function(e){if(void 0!==this.currentPage)return this.currentPage+=1,this.pager(e);var t=new i.Deferred;return t.reject(),t.promise()},requestPreviousPage:function(e){if(void 0!==this.currentPage)return this.currentPage-=1,this.pager(e);var t=new i.Deferred;return t.reject(),t.promise()},updateOrder:function(e){void 0!==e&&(this.sortField=e,this.pager())},goTo:function(e,t){if(void 0!==e)return this.currentPage=parseInt(e,10),this.pager(t);var n=new i.Deferred;return n.reject(),n.promise()},howManyPer:function(e){void 0!==e&&(this.currentPage=this.firstPage,this.perPage=e,this.pager())},info:function(){var e={totalRecords:this.totalRecords||0,currentPage:this.currentPage,firstPage:this.firstPage,totalPages:Math.ceil(this.totalRecords/this.perPage),lastPage:this.totalPages,perPage:this.perPage,previous:!1,next:!1};return this.currentPage>1&&(e.previous=this.currentPage-1),this.currentPage<e.totalPages&&(e.next=this.currentPage+1),e.hasNext=e.next,e.hasPrevious=e.next,e.pageSet=this.setPagination(e),this.information=e,e},setPagination:function(e){var t=[],i=0,n=0,a=2*this.pagesInRange,r=Math.ceil(e.totalRecords/e.perPage);if(r>1)if(1+a>=r)for(i=1,n=r;n>=i;i++)t.push(i);else if(e.currentPage<=this.pagesInRange+1)for(i=1,n=2+a;n>i;i++)t.push(i);else if(r-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange)for(i=e.currentPage-this.pagesInRange;e.currentPage+this.pagesInRange>=i;i++)t.push(i);else for(i=r-a;r>=i;i++)t.push(i);return t},pager:function(e){return t.isObject(e)||(e={}),this.fetch(e)},url:function(){return void 0!==this.paginator_core&&void 0!==this.paginator_core.url?this.paginator_core.url:null},bootstrap:function(e){return t.extend(this,e),this.setDefaults(),this.info(),this}}),n.requestPager.prototype.nextPage=n.requestPager.prototype.requestNextPage,n.requestPager.prototype.prevPage=n.requestPager.prototype.requestPreviousPage,n}(Backbone,_,jQuery);