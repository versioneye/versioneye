define(["underscore","backbone"],function(e,t){e.templateSettings={interpolate:/\{\{\=(.+?)\}\}/g,evaluate:/\{\{(.+?)\}\}/g};var n=function(t,n){var i=e.template($("#github-notification-template").html());$(".flash-container").html(i({classes:t,content:n})).fadeIn(400).delay(6e3).fadeOut(800)},i=t.View.extend({template:e.template($("#github-repo-switch-template").html()),events:{"click .github-switch":"onSwitchChange"},initialize:function(e){this.parent=e.parent,this.branch=e.branch,this.project_file=e.project_file},renderInfo:function(t){not_imported_tmpl=e.template("<strong> {{= filename }} </strong>"),imported_tmpl=e.template(['<a href="{{= url}}"> <strong>{{= filename }}</strong> </a>',", imported {{= moment(imported).fromNow() }}"].join(" "));var n="",i=this.project_file.path;return n=e.isNull(t)||e.isUndefined(t)?not_imported_tmpl({filename:i}):imported_tmpl({branch:this.branch,filename:i,url:t.project_url,imported:t.created_at})},getImportedFileInfo:function(t){var n=this.model.get("imported_files"),i=null,r=!1;return with_same_name=e.where(n,{branch:this.branch,filename:t}),e.isEmpty(with_same_name)||(r=!0,i=e.first(with_same_name)),{is_imported:r,info:i}},render:function(){var e=this.project_file.path,t=this.getImportedFileInfo(e),n=this.renderInfo(t.info);return this.$el.html(this.template({repo:this.model.toJSON(),branch:this.branch,filename:e,switch_id:this.getModelSwitchId(),switch_info:n,is_imported:t.is_imported,project_info:t.is_imported?t.info:{project_id:null}})),this},getModelSwitchId:function(){var t="github-repo-switch-"+this.project_file.uuid;return e.uniqueId(t)},onSwitchChange:function(t){{var n=$(t.currentTarget);n.data()}if(n.attr("disabled"))return console.log("Going to drop event of unactive switch."),t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),!1;var i=n.attr("checked");n.attr("checked",!i),this.disableSwitch(n);var r=e.template($("#github-notification-template").html()),a=r({classes:"alert alert-info",content:['<img src="/assets/loadingbar2.gif" style="height: 20px;" alt="loading" >',"<strong>Please wait!</strong> We are still importing data from SCM.","It may take up-to 4 seconds. But we are almost there."].join(" ")});return n.attr("checked")?(this.showRepoNotification(a),this.addProject(n)):this.removeProject(n),!0},disableSwitch:function(e){e.attr("disabled",!0),e.parents(".onoffswitch").addClass("disabled")},enableSwitch:function(e){e.attr("disabled",!1),e.parents(".onoffswitch").removeClass("disabled")},switchOnActivate:function(){var e=this.$el.find("input");e.attr("checked",!0),this.enableSwitch(e)},switchOffActivate:function(){var e=this.$el.find("input");e.attr("checked",!1),this.enableSwitch(e)},addProject:function(e){console.log("Adding new project");var t=this;this.model.save({command:"import",command_data:e.data()},{beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content"))},success:function(e){var n=t;n.onAddSuccess(e)},error:function(e,n){console.debug(n);var i=t;i.onAddFailure(e,n)}})},onAddSuccess:function(e){var t=e.get("command_result"),i=["<strong> Success! </strong>","Project file ",t.filename," on branch ",t.branch," of SCM project ",e.get("fullname")," is now successfully imported.","You can now checkout project's page."].join(" "),r=this.$el.find("input");return r.data("scmProjectId",t.project_id),this.updateRepoTitle(t),this.updateRepoProjectInfo(e),this.switchOnActivate(),this.hideRepoNotification(),n("alert alert-success",i),!0},onAddFailure:function(e,t){var i="";404==t.status?i="Server timeout. We are facing to many requests. Please Try again later.":500==t.status?i="An error occurred. Please try again later and contact us on Twitter @VersionEye.":(i="Can't import project: "+e.get("fullname")+". ",i+=t.responseText),console.debug("We encountered: "+t.status+" "+t.statusText),console.debug(i),n("alert alert-error",i),this.hideRepoNotification();var r=this.$el.find("input");return this.switchOffActivate(r),$(this.el).find(".repo-notification").html(""),!1},removeProject:function(e){console.log("Removing selected project.");var t=this;return this.model.save({command:"remove",command_data:e.data()},{beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content"))},success:function(e){var n=t;n.onRemoveSuccess(e)},error:function(e){var n=t;n.onRemoveFailure(e)}}),!1},onRemoveSuccess:function(e){var t=("#github-repo-"+e.get("github_id"),e.get("command_result")),i=["<strong>Success!</strong>","The Project's file ",t.filename," from the SCM repository ",e.get("fullname")," is now successfully removed."].join(" ");return this.updateRepoTitle(),this.updateRepoProjectInfo(e),this.switchOffActivate(),n("alert alert-success",i),this.hideRepoNotification(),!0},onRemoveFailure:function(){var e="Fail: Can not remove project";return this.switchOnActivate(),n("alert alert-warning",e),this.hideRepoNotification(),!1},updateRepoTitle:function(e){var t=this.renderInfo(e);this.$el.find(".item-title").html(t)},updateRepoProjectInfo:function(){var t=e.template($("#github-repo-project-info-template").html()),n=this.model.get("imported_files")||[],i=e.map(n,function(e){var t=e.branch+"/"+e.filename;return['<a href="',e.project_url,'" > ',t," </a>"].join("")}),r=t({branches:this.model.get("branches"),imported_urls:i});this.$el.parents(".repo-container").find(".repo-project-info").html(r)},showRepoNotification:function(e){notifier=$(this.el).parents(".repo-container").find(".repo-notification"),notifier.removeClass("hide"),notifier.html(e)},hideRepoNotification:function(){this.$el.parents(".repo-container").find(".repo-notification").html("").addClass("hide")}});return i});